Опишите структуру FileWriteState для хранения состояния буферизованного вывода в файл. Структура
может быть описана примерно так:
struct FileWriteState
{
    int fd;              // "файловый дескриптор", для вывода на стандартный поток вывода - 1
    unsigned char *buf;  // указатель на буфер
    int bufsize;         // размер буфера
    // здесь потребуется добавить поля для реализации буферизованной записи
};
Определите глобальную переменную:
struct FileWriteState *stout;
В вашей реализации переменная stout должна быть уже инициализирована корректным указателем
на корректную структуру состояния записи при запуске программы (то есть используйте инициализацию
глобальных переменных). Буфер должен быть выделен статически, его размер должен быть равен 4KiB.
Напишите подпрограммы writechar и flush для буферизированного посимвольного вывода.
void writechar(int c, struct FileWriteState *out);
void flush(struct FileWriteState *out);
Функция writechar принимает в регистре %ecx байт для вывода,
а в регистре %edx — указатель на структуру состояния вывода.
Этот байт не отправляется на поток вывода с помощью системного вызова write немедленно,
а накапливается в буфере вывода. Когда буфер вывода заполняется, вызывается подпрограмма flush
для записи содержимого буфера на устройство.
Функция flush принимает в регистре %ecx указатель на структуру состояния вывода.
Функция использует системный вызов write для записи содержимого буфера
за один раз. Будем предполагать, что операция записи завершается успешно и полностью
записывает буфер. Размер буфера - 4KiB.
Обратите внимание, что программа, использующая writechar, должна не забыть вызвать flush
перед завершением, так как в противном случае будет потеряна часть данных, еще находящаяся в выходном буфере.
Функции должны быть написаны на Си, но при этом вам не будет доступна стандартная библиотека Си, включая функцию write
(программа будет компилироваться с флагом -nostdlib). Для выполнения системного вызова записи используйте встроенный в gcc ассемблер
(ключевое слово asm). Обратите внимание, что для функции writechar используется необычное соглашение о вызовах функции.
Используйте конструкцию __attribute__ для управления соглашениями о вызове.
Опишите структуру FileReadState для хранения состояния буферизованного ввода из файла. Структура
может быть описана примерно так:
struct FileReadState
{
    int fd;              // "файловый дескриптор", для чтения со стандартного потока ввода - 0
    unsigned char *buf;  // указатель на буфер
    int bufsize;         // размер буфера
    int lc;              // последний считанный символ
    // здесь потребуется добавить поля для реализации буферизованного чтения
};
Определите глобальную переменную:
struct FileReadState *stin;
В вашей реализации переменная stin должна быть уже инициализирована корректным указателем
на корректную структуру состояния чтения при запуске программы (то есть используйте инициализацию
глобальных переменных). Буфер должен быть выделен статически, его размер должен быть равен 4KiB.
Напишите функцию nextchar на Си, выполняющую буферизованное чтение
одного символа со стандартного потока ввода. Функция nextchar
не принимает аргументов, но работает с глобальной переменной stin.
Функция возвращает считанный со стандартного потока ввода символ - целое число
в интервале [0; 255], а после достижения конца файла подпрограмма возвращает -1.
Кроме того, результат записывается в поле lc структуры.
Буферизация ввода выполняется следующим образом.
Чтение со стандартного потока ввода выполняется не побайтово, а блоками. За один системный вызов read
подпрограмма пытается заполнить внутренний буфер buf размера bufsize. При этом нормально, что read может
считать меньшее количество данных. Подпрограмма nextchar затем возвращает по одному байту из буфера в памяти.
Когда будет считано все содержимое буфера, буфер заполняется снова.
Когда при чтении со стандартного потока ввода read возвращает значение <= 0, устанавливается флаг
конца файла и все дальнейшие вызовы nextchar возвращают значение -1.
Напишите функцию lastchar, которая возвращает последний считанный символ, то есть значение поля lc.
Если до вызова lastchar не было вызова nextchar — поведение неопределено (т. е. делайте что хотите).
Функции должны быть написаны на Си, но при этом вам не будет доступна стандартная библиотека Си, включая функцию read
(программа будет компилироваться с флагом -nostdlib). Для выполнения системного вызова чтения используйте встроенный в gcc ассемблер
(ключевое слово asm).